<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Meine Chats | PetCareConnect</title>
    <link rel="stylesheet" th:href="@{/css/chats.css}" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>

<body>
<!-- HEADER -->
<div class="headerContainer">
    <div class="header">
        <a th:href="@{/}" class="logo">
            <img th:src="@{/images/logo1.png}" alt="PetCareConnect Logo" />
        </a>
        <div class="headerLinks">
            <a th:href="@{/}">Startseite</a>
            <a th:href="@{/betreuerfinden}">Betreuer finden</a>
            <a th:href="@{/chat-overview}">Chat</a>
            <a th:href="@{/contact}">Kontakt</a>

            <div th:if="${user != null}" class="userProfileBox">
                <a th:href="@{/profile}" th:text="${user.firstName + ' ' + user.lastName}" class="userNameLink"></a>
                <img th:src="@{/profile/image/{id}(id=${user.id})}" alt="Profilbild" class="profilePic" />
                <form th:action="@{/logout}" method="post">
                    <button class="btn" type="submit">Abmelden</button>
                </form>
            </div>

            <div class="notification-bell" id="notificationBell" title="Neue Nachricht">
                <span class="icon">ðŸ””</span>
                <span id="msgNotificationCount" class="badge" style="display: none;">0</span>
                <div id="notificationDropdown">
                    <ul id="notificationList"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CHAT OVERVIEW CONTENT -->
<div class="chat-overview-container">
    <h2>Meine Konversationen</h2>
    <div class="chat-list">
        <div th:each="entry : ${chatUsers}" class="chat-user">
            <a th:href="@{'/chat?receiverId=' + ${entry.user.id}}">
                <img th:src="@{/profile/image/{id}(id=${entry.user.id})}" class="avatar" alt="Profilbild" />
                <div class="chat-user-info">
                    <span th:text="${entry.user.firstName + ' ' + entry.user.lastName}">Name</span>
                    <small th:text="${entry.lastMessage}">Letzte Nachricht...</small>
                </div>
                <span th:text="${entry.timestamp}" class="chat-timestamp"></span>
            </a>
        </div>
    </div>
</div>

<!-- FOOTER -->
<div class="footerContainer">
    <div class="footer">
        <div class="footerColumns">
            <div class="footerColumn">
                <h3>PetCareConnect</h3>
                <p>Die beste Plattform fÃ¼r Haustierbetreuung in Deutschland</p>
            </div>
            <div class="footerColumn">
                <h3>Quick Links</h3>
                <a href="#">Ãœber uns</a>
                <a href="#">Services</a>
                <a href="#">Preise</a>
                <a href="#">FAQ</a>
            </div>
            <div class="footerColumn">
                <h3>Kontakt</h3>
                <p>info@petcareconnect.de</p>
                <p>+49 30 1234567</p>
            </div>
        </div>
        <div class="footerBottom">
            Â© 2023 PetCareConnect GmbH. Alle Rechte vorbehalten.
        </div>
    </div>
</div>

<!-- NOTIFICATION SCRIPT -->
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        const socket = new SockJS('/ws-chat');
        const stompClient = Stomp.over(socket);

        const notificationBell = document.getElementById("notificationBell");
        const notificationDropdown = document.getElementById("notificationDropdown");
        const notificationList = document.getElementById("notificationList");
        const badge = document.getElementById("msgNotificationCount");

        notificationBell.addEventListener("click", () => {
            notificationDropdown.style.display = notificationDropdown.style.display === "none" ? "block" : "none";
        });

        fetch('/api/notifications/unread')
            .then(response => response.json())
            .then(notifications => {
                if (notifications.length > 0) {
                    badge.style.display = "inline-block";
                    badge.innerText = notifications.length;
                    notifications.forEach(msg => showNotification(msg));
                }
            });

        stompClient.connect({}, function (frame) {
            stompClient.subscribe("/user/queue/notify", function (message) {
                const msg = JSON.parse(message.body);
                showNotification(msg);
                badge.style.display = "inline-block";
                badge.innerText = parseInt(badge.innerText || "0") + 1;
            });
        });

        function showNotification(msg) {
            const listItem = document.createElement("li");
            listItem.innerHTML = `
        <a href="/chat?receiverId=${msg.senderId}" style="text-decoration: none; color: #333;">
          Neue Nachricht von <strong>${msg.senderName}</strong><br/>
          <small>${msg.content}</small>
        </a>`;
            notificationList.prepend(listItem);
        }
    });
</script>

</body>
</html>
